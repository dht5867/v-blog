<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="我和你有个对话">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        springboot多数据源切换注解方式 - 悉陌伊人
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 学习使我快乐 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.png" />
        </div>
        <div class="name">
            <i>dht5867</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#springboot多数据源切换注解方式"><span class="toc-text">springboot多数据源切换注解方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置连接数据库信息"><span class="toc-text">配置连接数据库信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据源配置"><span class="toc-text">数据源配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态数据源持有者"><span class="toc-text">动态数据源持有者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态数据源实现类"><span class="toc-text">动态数据源实现类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定于数据源注解-主要用于dao切换数据源"><span class="toc-text">定于数据源注解,主要用于dao切换数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据源配置-加载配置的数据源，形成key-数据源"><span class="toc-text">数据源配置,加载配置的数据源，形成key - 数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据源AOP切面定义"><span class="toc-text">数据源AOP切面定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#springboot-关闭数据源自动配置，改为手动配置"><span class="toc-text">springboot 关闭数据源自动配置，改为手动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在mapper接口上使用数据源注解到目标数据源"><span class="toc-text">在mapper接口上使用数据源注解到目标数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意"><span class="toc-text">注意</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 学习使我快乐 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        springboot多数据源切换注解方式
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-07-03 19:53:54</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#-多数据源" title="-多数据源">-多数据源</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h1 id="springboot多数据源切换注解方式"><a href="#springboot多数据源切换注解方式" class="headerlink" title="springboot多数据源切换注解方式"></a>springboot多数据源切换注解方式</h1><h2 id="配置连接数据库信息"><a href="#配置连接数据库信息" class="headerlink" title="配置连接数据库信息"></a>配置连接数据库信息</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.inner</span><span class="selector-class">.type</span>=com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span></span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.inner</span><span class="selector-class">.url</span>=jdbc:mysql:<span class="comment">//</span></span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.inner</span><span class="selector-class">.username</span>=root</span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.inner</span><span class="selector-class">.password</span>=root </span><br><span class="line"></span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.third</span><span class="selector-class">.type</span>=com<span class="selector-class">.alibaba</span><span class="selector-class">.druid</span><span class="selector-class">.pool</span><span class="selector-class">.DruidDataSource</span></span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.third</span><span class="selector-class">.url</span>=jdbc:mysql:</span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.third</span><span class="selector-class">.username</span>=root</span><br><span class="line">spring<span class="selector-class">.datasource</span><span class="selector-class">.third</span><span class="selector-class">.password</span>=root</span><br></pre></td></tr></table></figure>

<h2 id="数据源配置"><a href="#数据源配置" class="headerlink" title="数据源配置"></a>数据源配置</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbDuridMysqlProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(name = <span class="string">"innerDataSource"</span>, destroyMethod = <span class="string">"close"</span>, initMethod = <span class="string">"init"</span>)</span><br><span class="line">  <span class="meta">@ConfigurationProperties</span>(<span class="string">"spring.datasource.inner"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">innerDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    DruidDataSource druidDataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    setDataSourcePool(druidDataSource);</span><br><span class="line">    <span class="keyword">return</span> druidDataSource;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span>(name = <span class="string">"thirdDataSource"</span>, destroyMethod = <span class="string">"close"</span>, initMethod = <span class="string">"init"</span>)</span><br><span class="line">  <span class="meta">@ConfigurationProperties</span>(<span class="string">"spring.datasource.third"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> DataSource <span class="title">thirdDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    DruidDataSource druidDataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    setDataSourcePool(druidDataSource);</span><br><span class="line">    <span class="keyword">return</span> druidDataSource;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态数据源持有者"><a href="#动态数据源持有者" class="headerlink" title="动态数据源持有者"></a>动态数据源持有者</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态数据源持有者，负责利用ThreadLocal存取数据源名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DynamicDataSourceHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 本地线程共享对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> final ThreadLocal&lt;String&gt; THREAD_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putDataSource</span>(<span class="params">String name</span>)</span> &#123;</span><br><span class="line">    THREAD_LOCAL.<span class="keyword">set</span>(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDataSource</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> THREAD_LOCAL.<span class="keyword">get</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeDataSource</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    THREAD_LOCAL.<span class="keyword">remove</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="动态数据源实现类"><a href="#动态数据源实现类" class="headerlink" title="动态数据源实现类"></a>动态数据源实现类</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态数据源实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//数据源路由，此方用于产生要选取的数据源逻辑名称</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">Object</span> determineCurrentLookupKey() &#123;</span><br><span class="line">    <span class="comment">//从共享线程中获取数据源名称</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">DynamicDataSourceHolder</span>.getDataSource();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定于数据源注解-主要用于dao切换数据源"><a href="#定于数据源注解-主要用于dao切换数据源" class="headerlink" title="定于数据源注解,主要用于dao切换数据源"></a>定于数据源注解,主要用于dao切换数据源</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 目标数据源注解，注解在方法上指定数据源的名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Target</span>(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="variable">@Documented</span></span><br><span class="line">public <span class="variable">@interface</span> TargetDataSource &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//此处接收的是数据源的名称</span></span><br><span class="line">  <span class="selector-tag">String</span> <span class="selector-tag">value</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据源配置-加载配置的数据源，形成key-数据源"><a href="#数据源配置-加载配置的数据源，形成key-数据源" class="headerlink" title="数据源配置,加载配置的数据源，形成key - 数据源"></a>数据源配置,加载配置的数据源，形成key - 数据源</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bmsoft.newborn.config.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bmsoft.newborn.config.dds.DynamicDataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.<span class="keyword">annotation</span>.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据源配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@MapperScan(&#123;<span class="meta-string">"com.bmsoft.newborn.mapper.inner"</span>, <span class="meta-string">"com.bmsoft.newborn.mapper.third"</span>&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DbDuridMysqlProperties duridMysqlProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@Primary</span> 该注解表示在同一个接口有多个实现类可以注入的时候，默认选择哪一个，而不是让<span class="doctag">@autowire</span>注解报错</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@Qualifier</span> 根据名称进行注入，通常是在具有相同的多个类型的实例的一个注入（例如有多个DataSource类型的实例）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean(name = <span class="meta-string">"dataSource"</span>)</span></span><br><span class="line">  <span class="meta">@Primary</span></span><br><span class="line">  <span class="keyword">public</span> DynamicDataSource dataSource() throws SQLException &#123;</span><br><span class="line">    <span class="comment">//按照目标数据源名称和目标数据源对象的映射存放在Map中</span></span><br><span class="line">    <span class="comment">//采用是想AbstractRoutingDataSource的对象包装多数据源</span></span><br><span class="line">    DynamicDataSource dynamicDataSource = new DynamicDataSource();</span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;&gt;();</span><br><span class="line">    targetDataSources.put(<span class="string">"inner"</span>, duridMysqlProperties.innerDataSource());</span><br><span class="line">    targetDataSources.put(<span class="string">"third"</span>, duridMysqlProperties.thirdDataSource());</span><br><span class="line"></span><br><span class="line">    dynamicDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">    <span class="comment">//设置默认的数据源，当拿不到数据源时，使用此配置</span></span><br><span class="line">    dynamicDataSource.setDefaultTargetDataSource(duridMysqlProperties.innerDataSource());</span><br><span class="line">    <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开启事务</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> PlatformTransactionManager txManager() throws SQLException &#123;</span><br><span class="line">    <span class="keyword">return</span> new DataSourceTransactionManager(dataSource());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据源AOP切面定义"><a href="#数据源AOP切面定义" class="headerlink" title="数据源AOP切面定义"></a>数据源AOP切面定义</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bmsoft.newborn.config.datasource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bmsoft.newborn.<span class="keyword">annotation</span>.TargetDataSource;</span><br><span class="line"><span class="keyword">import</span> com.bmsoft.newborn.config.dds.DynamicDataSourceHolder;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.<span class="keyword">annotation</span>.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.<span class="keyword">annotation</span>.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据源AOP切面定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Order(4)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//切换放在mapper接口的方法上，所以这里要配置AOP切面的切入点</span></span><br><span class="line">  <span class="meta">@Pointcut(<span class="meta-string">"execution( * com.bmsoft.newborn.mapper.*.*.*(..))"</span>)</span></span><br><span class="line">  <span class="keyword">public</span> void dataSourcePointCut() &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before(<span class="meta-string">"dataSourcePointCut()"</span>)</span></span><br><span class="line">  <span class="keyword">public</span> void before(JoinPoint joinPoint) throws Exception &#123;</span><br><span class="line">    Object target = joinPoint.getTarget();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Signature 包含了方法名、申明类型以及地址等信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//方法名称</span></span><br><span class="line">    String method = joinPoint.getSignature().getName();</span><br><span class="line">    <span class="comment">//参数值</span></span><br><span class="line">    Object[] paramValues = joinPoint.getArgs();</span><br><span class="line">    Class&lt;?&gt;[] clazz = target.getClass().getInterfaces();</span><br><span class="line">    Class&lt;?&gt;[] parameterTypes = ((MethodSignature) joinPoint.getSignature()).getMethod()</span><br><span class="line">        .getParameterTypes();</span><br><span class="line">    <span class="comment">//获取参数类型</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//类上或者方法上存在注解</span></span><br><span class="line">      Method m = clazz[<span class="number">0</span>].getMethod(method, parameterTypes);</span><br><span class="line">      Class&lt;?&gt; declaringClass = m.getDeclaringClass();</span><br><span class="line">      <span class="keyword">if</span> (declaringClass.isAnnotationPresent(TargetDataSource.<span class="keyword">class</span>)) &#123;</span><br><span class="line">        TargetDataSource <span class="keyword">data</span> = declaringClass.getAnnotation(TargetDataSource.<span class="keyword">class</span>);</span><br><span class="line">        changeDataSource(<span class="keyword">data</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (m.isAnnotationPresent(TargetDataSource.<span class="keyword">class</span>)) &#123;</span><br><span class="line">        TargetDataSource <span class="keyword">data</span> = m.getAnnotation(TargetDataSource.<span class="keyword">class</span>);</span><br><span class="line">        <span class="comment">//可以根据参数获取当前数据源</span></span><br><span class="line">        changeDataSource(<span class="keyword">data</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"当前线程 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源失败"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> void changeDataSource(TargetDataSource <span class="keyword">data</span>) &#123;</span><br><span class="line">    <span class="comment">//可以根据参数获取当前数据源</span></span><br><span class="line">    String deafultSourceName = <span class="keyword">data</span>.value();</span><br><span class="line">    log.info(</span><br><span class="line">            <span class="string">"使用数据源 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源到-- "</span> + deafultSourceName</span><br><span class="line">                    + <span class="string">" 本地线程变量"</span>);</span><br><span class="line">    DynamicDataSourceHolder.putDataSource(deafultSourceName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> void changeDataSource(Object[] paramValues, TargetDataSource <span class="keyword">data</span>) &#123;</span><br><span class="line">    <span class="comment">//可以根据参数获取当前数据源</span></span><br><span class="line">    String deafultSourceName = <span class="keyword">data</span>.value();</span><br><span class="line">    <span class="keyword">if</span> (paramValues != <span class="literal">null</span> &amp;&amp; paramValues.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      log.info(</span><br><span class="line">          <span class="string">"使用数据源 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源到-- "</span> + deafultSourceName</span><br><span class="line">              + <span class="string">" 本地线程变量"</span>);</span><br><span class="line">      DynamicDataSourceHolder.putDataSource(deafultSourceName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//执行完切面后，将线程共享中的数据源名称清空</span></span><br><span class="line">  <span class="meta">@After(<span class="meta-string">"dataSourcePointCut()"</span>)</span></span><br><span class="line">  <span class="keyword">public</span> void after(JoinPoint joinPoint) &#123;</span><br><span class="line">    DynamicDataSourceHolder.removeDataSource();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="springboot-关闭数据源自动配置，改为手动配置"><a href="#springboot-关闭数据源自动配置，改为手动配置" class="headerlink" title="springboot 关闭数据源自动配置，改为手动配置"></a>springboot 关闭数据源自动配置，改为手动配置</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bmsoft.newborn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = DataSourceAutoConfiguration.<span class="keyword">class</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroNewbornServiceApplication</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> BCryptPasswordEncoder bCryptPasswordEncoder() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">    SpringApplication.run(MicroNewbornServiceApplication.<span class="keyword">class</span>, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在mapper接口上使用数据源注解到目标数据源"><a href="#在mapper接口上使用数据源注解到目标数据源" class="headerlink" title="在mapper接口上使用数据源注解到目标数据源"></a>在mapper接口上使用数据源注解到目标数据源</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.bmsoft</span><span class="selector-class">.newborn</span><span class="selector-class">.mapper</span><span class="selector-class">.inner</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.bmsoft</span><span class="selector-class">.newborn</span><span class="selector-class">.annotation</span><span class="selector-class">.TargetDataSource</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.bmsoft</span><span class="selector-class">.newborn</span><span class="selector-class">.domain</span><span class="selector-class">.inner</span><span class="selector-class">.Dict</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.apache</span><span class="selector-class">.ibatis</span><span class="selector-class">.annotations</span><span class="selector-class">.Param</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">java</span><span class="selector-class">.util</span><span class="selector-class">.List</span>;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">TargetDataSource</span>("<span class="keyword">inner</span>")</span><br><span class="line"><span class="keyword">public</span> interface DictMapper  &#123;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">Dict</span> <span class="selector-tag">selectById</span>(@<span class="keyword">Param</span>("<span class="keyword">code</span>") String code);</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">List</span>&lt;<span class="selector-tag">Dict</span>&gt; <span class="selector-tag">selectAllDict</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>1、同一个service中如果启动事务注解@Transaction，数据源切换将不起作用，需要改为分布式事务<br>2、需要注意配置默认的数据源，不然在非注解的情况下，查询SQL会报错<br>3、在aop 切换数据源时，可以在mapper中传入固定的参数，解析参数可以做切换数据源处理,利用反射获取主键方法的方法传参值进行切换</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据源AOP切面定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">@Slf4j</span><br><span class="line">@Order(<span class="number">4</span>)</span><br><span class="line">@PropertySource(<span class="string">"classpath:datasource.properties"</span>)<span class="comment">//这是多数据源属性文件路径</span></span><br><span class="line"><span class="keyword">public</span> class DataSourceAspect &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//切换放在mapper接口的方法上，所以这里要配置AOP切面的切入点</span></span><br><span class="line">    @Pointcut(<span class="string">"execution( * com.bmsoft.wfy.mapper.*.*.*(..))"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> dataSourcePointCut() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Before(<span class="string">"dataSourcePointCut()"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> before(JoinPoint joinPoint) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">Object</span> target = joinPoint.getTarget();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Signature 包含了方法名、申明类型以及地址等信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">String</span> class_name = joinPoint.getTarget().getClass().getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//方法名称</span></span><br><span class="line">        <span class="keyword">String</span> method = joinPoint.getSignature().getName();</span><br><span class="line">        <span class="comment">//参数值</span></span><br><span class="line">        <span class="keyword">Object</span>[] paramValues = joinPoint.getArgs();</span><br><span class="line">        Class&lt;?&gt;[] clazz = target.getClass().getInterfaces();</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes = ((MethodSignature) joinPoint.getSignature()).getMethod().getParameterTypes();</span><br><span class="line">        <span class="comment">//获取参数类型</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method m = clazz[<span class="number">0</span>].getMethod(method, parameterTypes);</span><br><span class="line">            <span class="comment">//如果方法上存在切换数据源的注解，则根据注解内容进行数据源切换</span></span><br><span class="line">            <span class="keyword">if</span> (m != <span class="keyword">null</span> &amp;&amp; m.isAnnotationPresent(TargetDataSource.class)) &#123;</span><br><span class="line">                TargetDataSource data = m.getAnnotation(TargetDataSource.class);</span><br><span class="line">                <span class="comment">//可以根据参数获取当前数据源</span></span><br><span class="line">                <span class="keyword">String</span> deafultSourceName = data.value();</span><br><span class="line">                <span class="keyword">if</span> (paramValues != <span class="keyword">null</span> &amp;&amp; paramValues.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; paramValues.length; i++) &#123;</span><br><span class="line">                        <span class="built_in">log</span>.info(<span class="string">"数据源方法"</span> + method);</span><br><span class="line">                        <span class="built_in">log</span>.info(<span class="string">"请求参数类型"</span> + parameterTypes[i]);</span><br><span class="line">                        <span class="keyword">if</span> (parameterTypes[i] == Map.class) &#123;</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"Map类型值"</span> + paramValues[i]);</span><br><span class="line">                            Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; <span class="built_in">map</span> = (<span class="keyword">HashMap</span>) paramValues[i];</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"转换之后的Map类型值"</span> + <span class="built_in">map</span>);</span><br><span class="line">                            <span class="comment">//获取法院代码</span></span><br><span class="line">                            <span class="keyword">Object</span> courtNumber = <span class="built_in">map</span>.<span class="built_in">get</span>(<span class="string">"courtNumber"</span>);</span><br><span class="line">                            <span class="keyword">String</span> court =<span class="string">""</span>;</span><br><span class="line">                            <span class="keyword">if</span>(courtNumber!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                                court =<span class="keyword">String</span>.valueOf(courtNumber);</span><br><span class="line">                            &#125;</span><br><span class="line">                            changeDataSource(deafultSourceName, courtNumber, court);</span><br><span class="line"></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameterTypes[i] == List.class) &#123;</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"List类型值"</span> + paramValues[i]);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"对象类型值"</span> + paramValues[i]);</span><br><span class="line">                            <span class="keyword">final</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; stringStringMap = obj2Map(paramValues[i]);</span><br><span class="line">                            <span class="built_in">log</span>.info(<span class="string">"对象转为map后的值"</span> + stringStringMap);</span><br><span class="line">                            <span class="keyword">Object</span> courtNumber = stringStringMap.<span class="built_in">get</span>(<span class="string">"courtNumber"</span>);</span><br><span class="line">                            <span class="keyword">String</span> court =<span class="string">""</span>;</span><br><span class="line">                            <span class="keyword">if</span>(courtNumber!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                                court =<span class="keyword">String</span>.valueOf(courtNumber);</span><br><span class="line">                            &#125;</span><br><span class="line">                            changeDataSource(deafultSourceName, courtNumber, court);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//TODO,默认MySQL数据源的处理</span></span><br><span class="line">                <span class="comment">//mapper 接口没有数据源注解,使用MySQL数据库</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用默认mysql数据源"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="built_in">log</span>.error(<span class="string">"当前线程 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更换连接的数据源</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> changeDataSource(<span class="keyword">String</span> deafultSourceName, <span class="keyword">Object</span> courtNumber, <span class="keyword">String</span> court) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(court)&amp;&amp; !<span class="string">""</span>.equals(court) &amp;&amp;!<span class="string">"null"</span>.equalsIgnoreCase(court)&amp;&amp;court.length()&gt;=<span class="number">4</span>) &#123;</span><br><span class="line">            court = court.substring(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="comment">//TODO,当前只有一个Sybase数据库,后期多个进行扩展</span></span><br><span class="line">            <span class="keyword">if</span> ( StringUtils.isNotBlank(deafultSourceName)&amp;&amp;deafultSourceName.indexOf(<span class="string">"sybase"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">String</span> <span class="built_in">key</span> = <span class="string">"datasource.sybase."</span> + court;</span><br><span class="line">                <span class="comment">//使用 3200 3201 3202  </span></span><br><span class="line">                <span class="keyword">String</span> dataSourceName = env.getProperty(<span class="built_in">key</span>);</span><br><span class="line">                DynamicDataSourceHolder.putDataSource(dataSourceName);</span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用线程 "</span> + Thread.currentThread().getName() + <span class="string">" sybase添加--案件 "</span> + <span class="string">"法院代码---"</span> + courtNumber + <span class="string">"--的数据源----"</span> + dataSourceName + <span class="string">" 本地线程变量"</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>( StringUtils.isNotBlank(deafultSourceName)&amp;&amp;deafultSourceName.indexOf(<span class="string">"mysql"</span>) != <span class="number">-1</span>)&#123;</span><br><span class="line">                <span class="comment">//使用其他库的判断</span></span><br><span class="line">                <span class="keyword">String</span> <span class="built_in">key</span> = <span class="string">"datasource.mysql."</span> + court;</span><br><span class="line">                <span class="comment">//使用 3200 3201 3202  </span></span><br><span class="line">                <span class="keyword">String</span> dataSourceName = env.getProperty(<span class="built_in">key</span>);</span><br><span class="line">                DynamicDataSourceHolder.putDataSource(dataSourceName);</span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用线程 "</span> + Thread.currentThread().getName() + <span class="string">"mysql 添加--执行 "</span> + <span class="string">"法院代码---"</span> + courtNumber + <span class="string">"--的数据源----"</span> + dataSourceName + <span class="string">" 本地线程变量"</span>);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>( StringUtils.isNotBlank(deafultSourceName)&amp;&amp;deafultSourceName.indexOf(<span class="string">"oa"</span>) != <span class="number">-1</span>)&#123;</span><br><span class="line">                <span class="comment">//使用其他库的判断</span></span><br><span class="line">                <span class="comment">//log.info("使用线程 " + Thread.currentThread().getName() + "sybaseoa 添加--执行 " + "法院代码---" + courtNumber + "--的数据源----" + dataSourceName + " 本地线程变量");</span></span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用默认江苏高院OA"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">String</span> <span class="built_in">key</span> = <span class="string">"datasource.oa.3200"</span>;</span><br><span class="line">                <span class="comment">//使用 3200 3201 3202 的办公oa</span></span><br><span class="line">                <span class="keyword">String</span> dataSourceName = env.getProperty(<span class="built_in">key</span>);</span><br><span class="line">                DynamicDataSourceHolder.putDataSource(dataSourceName);</span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用线程 "</span> + Thread.currentThread().getName() + <span class="string">"sybaseoa 添加--执行 "</span> + <span class="string">"法院代码---"</span> + courtNumber + <span class="string">"--的数据源----"</span> + dataSourceName + <span class="string">" 本地线程变量"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//TODO,没有传法院代码的情况默认使用集中库</span></span><br><span class="line">            <span class="comment">//判断注解上的值,为集中库上的值</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"sybaseTtre"</span>.equalsIgnoreCase(deafultSourceName)) &#123;</span><br><span class="line">                DynamicDataSourceHolder.putDataSource(deafultSourceName);</span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用Sybase集中库线程 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源到-- "</span> + deafultSourceName + <span class="string">" 本地线程变量"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//TODO 当事人测试使用,后期会更改</span></span><br><span class="line">                DynamicDataSourceHolder.putDataSource(<span class="string">"sybaseTtre"</span>);</span><br><span class="line">                <span class="built_in">log</span>.info(<span class="string">"使用Sybase集中库线程 "</span> + Thread.currentThread().getName() + <span class="string">" 添加数据源到-- "</span> + deafultSourceName + <span class="string">" 本地线程变量"</span>);</span><br><span class="line">                <span class="comment">//TODO,目前不传法院代码,只有一个集中库的情况,后期进行扩展</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; obj2Map(<span class="keyword">Object</span> obj) &#123;</span><br><span class="line">        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;();</span><br><span class="line">        <span class="comment">// System.out.println(obj.getClass());</span></span><br><span class="line">        <span class="comment">// 获取f对象对应类中的所有属性域</span></span><br><span class="line">        Field[] fields = obj.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>, len = fields.length; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">String</span> varName = fields[i].getName();</span><br><span class="line">            <span class="comment">//varName = varName.toLowerCase();//将key置为小写，默认为对象的属性</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 获取原来的访问控制权限</span></span><br><span class="line">                <span class="built_in">boolean</span> accessFlag = fields[i].isAccessible();</span><br><span class="line">                <span class="comment">// 修改访问控制权限</span></span><br><span class="line">                fields[i].setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// 获取在对象f中属性fields[i]对应的对象中的变量</span></span><br><span class="line">                <span class="keyword">Object</span> o = fields[i].<span class="built_in">get</span>(obj);</span><br><span class="line">                <span class="keyword">if</span> (o != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="built_in">map</span>.put(varName, o.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// System.out.println("传入的对象中包含一个如下的变量：" + varName + " = " + o);</span></span><br><span class="line">                <span class="comment">// 恢复访问控制权限</span></span><br><span class="line">                fields[i].setAccessible(accessFlag);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">map</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行完切面后，将线程共享中的数据源名称清空</span></span><br><span class="line">    @After(<span class="string">"dataSourcePointCut()"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> after(JoinPoint joinPoint) &#123;</span><br><span class="line">        DynamicDataSourceHolder.removeDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">        <span class="keyword">String</span> courtNumer = <span class="string">"320100"</span>;</span><br><span class="line">        System.out.<span class="built_in">println</span>(courtNumer.substring(<span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        <li>
            <a target="_blank" href="https://twitter.com/dht5867">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-twitter"></i>
                            </span>
            </a>
        </li>
        
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/悉陌伊人">
                            <span class="fa-stack fa-lg">
                                 <i class="iconfont icon-zhihu"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank" href="http://weibo.com/1228463344">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank" href="https://www.facebook.com/dht5867">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-facebook"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank"  href="https://github.com/dht5867">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank"  href="https://www.linkedin.com/in/dht5867">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-linkedin"></i>
                            </span>
            </a>
        </li>
        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="#">It helps SEO</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a>
    </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




</html>
